===============================================================================
                    GUIDE STRIPE - PAIEMENTS R√âCURRENTS & UNIQUES
                    Bas√© sur les meilleures pratiques (vid√©o YouTube)
===============================================================================

üìã R√âSUM√â
---------
M√©thode simple pour accepter des paiements avec Stripe en utilisant :
- Payment Links (liens de paiement h√©berg√©s par Stripe)
- Webhooks (notifications automatiques)
- Customer Portal (gestion des abonnements par le client)

===============================================================================

üõ†Ô∏è CONFIGURATION STRIPE (Dashboard)
====================================

1. CR√âER UN PRODUIT
   - Aller sur Stripe Dashboard > Product Catalog
   - "Add a new product"
   - Nom : "D√©blocage niveaux - Test Civique"
   - Prix : 0,99‚Ç¨ (paiement unique)

2. CR√âER UN PAYMENT LINK
   - S√©lectionner le produit > "Create payment link"
   - ‚úÖ Cocher "Allow business customers to provide tax ID" (pour TVA)
   - After payment > Custom message :
     "Merci pour votre achat ! Retournez sur l'application et rafra√Æchissez la page."
   - Copier le Payment Link URL
   - Copier le Price ID (commence par price_...)

3. R√âCUP√âRER LES CL√âS API
   - Developer > API Keys
   - Copier la "Secret Key" (sk_test_... ou sk_live_...)
   - ‚ö†Ô∏è Ne JAMAIS exposer c√¥t√© client !

===============================================================================

üîó INT√âGRATION PAYMENT LINK (Frontend)
======================================

// Quand l'utilisateur clique sur "Acheter"
const handlePurchase = () => {
  const paymentLink = "https://buy.stripe.com/votre_link"
  const userEmail = user.email
  
  // Ouvrir Stripe avec l'email pr√©-rempli
  window.open(`${paymentLink}?prefilled_email=${encodeURIComponent(userEmail)}`)
}

‚úÖ Avantages :
- Z√©ro code backend pour le paiement
- Page s√©curis√©e h√©berg√©e par Stripe
- Supporte cartes, Apple Pay, Google Pay

===============================================================================

ü™ù WEBHOOKS - CONFIGURATION
===========================

1. EN D√âVELOPPEMENT LOCAL
   - Installer Stripe CLI : https://stripe.com/docs/stripe-cli
   - Terminal 1 : stripe login
   - Terminal 2 : stripe listen --forward-to localhost:3000/api/webhook/stripe
   - Copier le Webhook Signing Secret (whsec_...)

2. EN PRODUCTION
   - Dashboard > Developers > Webhooks > Add endpoint
   - URL : https://votredomaine.com/api/webhook/stripe
   - √âv√©nements √† √©couter :
     ‚úÖ checkout.session.completed (paiement r√©ussi)
     ‚úÖ customer.subscription.deleted (abonnement annul√©)

===============================================================================

ü™ù WEBHOOKS - CODE API (Next.js)
================================

// app/api/webhook/stripe/route.ts

import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!

export async function POST(req: Request) {
  const body = await req.text()
  const signature = req.headers.get('stripe-signature')!

  let event: Stripe.Event

  // V√©rifier que le webhook vient bien de Stripe
  try {
    event = stripe.webhooks.constructEvent(body, signature, webhookSecret)
  } catch (err) {
    return new Response('Webhook signature verification failed', { status: 400 })
  }

  // Traiter les √©v√©nements
  switch (event.type) {
    case 'checkout.session.completed':
      // Paiement r√©ussi ‚Üí Activer l'acc√®s
      const session = event.data.object as Stripe.Checkout.Session
      const customerEmail = session.customer_details?.email
      
      // Mettre √† jour la base de donn√©es
      await activateUserAccess(customerEmail)
      break

    case 'customer.subscription.deleted':
      // Abonnement annul√© ‚Üí R√©voquer l'acc√®s
      const subscription = event.data.object as Stripe.Subscription
      const customerId = subscription.customer as string
      
      await revokeUserAccess(customerId)
      break
  }

  return new Response('OK', { status: 200 })
}

===============================================================================

üìß √âV√âNEMENTS STRIPE UTILES
===========================

ESSENTIELS :
- checkout.session.completed  ‚Üí Paiement r√©ussi, donner acc√®s
- customer.subscription.deleted ‚Üí Fin abonnement, r√©voquer acc√®s

OPTIONNELS (marketing/avanc√©) :
- checkout.session.expired ‚Üí Client a quitt√© sans payer
  ‚Üí Envoyer email "Vous avez oubli√© ? -20% avec ce code"
  
- invoice.payment_failed ‚Üí Carte refus√©e
  ‚Üí Attendre fin du cycle avant de couper l'acc√®s (plus friendly)
  
- invoice.paid ‚Üí Paiement mensuel r√©ussi
  ‚Üí Utile si vous coupez l'acc√®s imm√©diatement apr√®s √©chec

===============================================================================

üë§ CUSTOMER PORTAL (Gestion abonnement)
=======================================

1. CONFIGURATION
   - Dashboard > Settings > Billing > Customer portal
   - Activer les options souhait√©es (annulation, upgrade, etc.)
   - Copier le lien du Customer Portal

2. INT√âGRATION
   const customerPortalLink = "https://billing.stripe.com/p/login/votre_link"
   
   // Bouton "G√©rer mon abonnement"
   <a href={`${customerPortalLink}?prefilled_email=${user.email}`}>
     G√©rer mon abonnement
   </a>

‚úÖ Le client peut :
- T√©l√©charger ses factures PDF
- Changer de carte bancaire
- Annuler son abonnement
- Modifier son plan

===============================================================================

üöÄ CHECKLIST PRODUCTION
=======================

‚ñ° D√©sactiver le mode test sur Stripe
‚ñ° Remplacer les cl√©s API test par les cl√©s live
‚ñ° Cr√©er le webhook en production (URL r√©elle)
‚ñ° Tester un vrai paiement avec une vraie carte
‚ñ° V√©rifier les emails de confirmation Stripe
‚ñ° Configurer les emails automatiques (Settings > Emails)

===============================================================================

üí° CONSEILS DE L'EXPERT
=======================

1. PAIEMENT UNIQUE vs ABONNEMENT
   "Quand vous d√©butez, un paiement unique (ex: 99‚Ç¨ √† vie) est 
   BEAUCOUP plus facile √† vendre qu'un abonnement (ex: 19‚Ç¨/mois).
   √áa vous motive car vous faites des ventes rapidement."

2. PR√â-REMPLIR L'EMAIL
   Toujours passer l'email de l'utilisateur connect√© dans l'URL
   ‚Üí ?prefilled_email=user@example.com
   ‚Üí √âvite les erreurs et facilite le matching dans la DB

3. MESSAGE POST-PAIEMENT
   Toujours dire au client de "rafra√Æchir la page" ou "retourner 
   sur l'app" apr√®s le paiement pour voir ses acc√®s.

4. EMAIL DE BIENVENUE
   Apr√®s le webhook checkout.session.completed, envoyer un email
   avec le lien de connexion en cas o√π le client ferme l'onglet.

5. GESTION DES √âCHECS DE PAIEMENT
   Ne pas couper l'acc√®s imm√©diatement si la carte est refus√©e.
   Attendre la fin du cycle de facturation (plus friendly).

===============================================================================

üìÅ VARIABLES D'ENVIRONNEMENT N√âCESSAIRES
========================================

# .env.local
STRIPE_SECRET_KEY=sk_test_... (ou sk_live_... en prod)
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PAYMENT_LINK=https://buy.stripe.com/...
STRIPE_PRICE_ID=price_...

===============================================================================

üéØ POUR NOTRE CAS (Test Civique France)
=======================================

Notre cas est SIMPLE : paiement unique de 0,99‚Ç¨

1. Cr√©er le produit "D√©blocage niveaux" sur Stripe (0,99‚Ç¨, one-time)
2. Cr√©er un Payment Link
3. Cr√©er le webhook qui √©coute checkout.session.completed
4. Dans le webhook : appeler activate_purchase(user_id) sur Supabase
5. L'utilisateur a maintenant all_levels_unlocked = true

Pas besoin de :
- Customer Portal (pas d'abonnement √† g√©rer)
- customer.subscription.deleted (pas d'abonnement)
- Factures complexes (Stripe envoie le re√ßu automatiquement)

===============================================================================
